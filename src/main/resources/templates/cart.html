<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Корзина - Cake House</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;700&family=Love+Light&display=swap" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/cart.css}">
</head>
<body>

<header class="header">
  <nav class="navigation-menu">
    <ul class="nav-list">
      <li><a th:href="@{/about}" th:text="${navAbout}">Про нас</a></li>
      <li><a th:href="@{/assortment}" th:text="${navAssortment}">Асортимент</a></li>
      <li class="logo"><a th:href="@{/}" th:text="${headerTitle}">Cake House</a></li>
      <li><a th:href="@{/reviews}" th:text="${navReviews}">Відгуки</a></li>
      <li class="icons">
        <a th:href="@{/cart}" id="openCartButton"><img th:src="@{/img/cart-icon.svg}" alt="Cart"></a>
      </li>
      <li class="icons">
           <span sec:authorize="isAuthenticated()">
                 <a href="#"> <img th:src="@{/img/user-icon.svg}" alt="Logged In User">
                 </a>
           </span>
        <span sec:authorize="isAnonymous()">
               <a th:href="@{/login-form}" id="openUserButton"><img th:src="@{/img/user-icon.svg}" alt="Login/Register"></a>
           </span>
      </li>
      <li sec:authorize="isAuthenticated()">
        <form th:action="@{/logout}" method="post">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" sec:authorize="!isAnonymous()"/>
          <button type="submit" class="logout-button">Вихід</button>
        </form>
      </li>
    </ul>
  </nav>
</header>

<main class="container mx-auto py-8">
  <h1 class="text-3xl text-center mb-6">Ваша корзина</h1>

  <div class="text-center mb-6">
    <div sec:authorize="isAuthenticated()">
      <p class="text-xl">
        <span th:text="${userFirstName != null ? userFirstName : #authentication?.principal?.username}">Користувач</span>, оформіть своє замовлення!
      </p>
    </div>
    <div sec:authorize="isAnonymous()">
      <p class="text-xl text-gray-600">
        Будь ласка, <a th:href="@{/login-form}">увійдіть</a> або <a th:href="@{/registration}">зареєструйтеся</a>, щоб оформити замовлення.
      </p>
    </div>
  </div>

  <div th:if="${errorMessage}" class="text-red-500 text-center mb-4">
    <p th:text="${errorMessage}"></p>
  </div>


  <div class="grid gap-6 mb-8" th:if="${cartItems != null and !cartItems.isEmpty()}">
    <div th:each="item, itemStat : ${cartItems}" class="bg-white text-black rounded-lg p-4 shadow">
      <div class="flex justify-between items-center">
        <div class="flex items-center">
          <img th:src="@{'/img/' + ${item.assortment.imageName}}" th:alt="${item.assortment.name}" class="cart-item-image mr-4" style="width: 80px; height: 80px; object-fit: cover;">
          <div>
            <h2 class="text-xl font-semibold" th:text="${item.assortment.name}">Назва товару</h2>
            <div class="flex items-center mt-2">
              <form th:action="@{/cart/update}" method="post" class="quantity-form inline-block">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" sec:authorize="!isAnonymous()"/>
                <input type="hidden" name="assortmentId" th:value="${item.assortment.id}" />
                <input type="number"
                       name="quantity"
                       th:value="${item.quantity}"
                       min="1"
                       class="w-20 text-center border rounded-md py-1 mr-2 quantity-input"/>
                <button type="submit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-2 rounded-md text-sm" style="display: none;">Оновити</button>
              </form>
              <p class="mr-2">Ціна за одиницю: <span class="unit-price" th:text="${item.assortment.price}"></span> ₴</p>
            </div>
          </div>
        </div>
        <div class="text-right">
          <p class="text-lg font-bold">Сума: <span class="item-total" th:text="${item.quantity * item.assortment.price}"></span> ₴</p>
          <form th:action="@{/cart/remove}" method="post" class="mt-2 inline-block">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" sec:authorize="!isAnonymous()"/>
            <input type="hidden" name="assortmentId" th:value="${item.assortment.id}" />
            <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-md text-sm">Видалити</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <p class="text-center text-xl" th:if="${cartItems == null or cartItems.isEmpty()}">Корзина порожня.</p>

  <div th:if="${cartItems != null and !cartItems.isEmpty() and #authentication?.authenticated == true}" class="checkout-form-container">
    <div class="text-right mt-6 text-2xl font-bold mb-4">
      <p>Загальна сума: <span id="total-price-display" th:text="${total}"></span> ₴</p>
    </div>

    <form th:action="@{/cart/order/place}" method="post" id="checkout-form">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" sec:authorize="!isAnonymous()"/>

      <h2 class="text-xl font-semibold mb-4">Оберіть спосіб отримання:</h2>
      <div class="mb-4">
        <input type="radio" id="pickup" name="deliveryMethod" value="PICKUP" checked> <label for="pickup">Самовивіз з пекарні</label>
      </div>
      <div class="mb-4">
        <input type="radio" id="delivery" name="deliveryMethod" value="DELIVERY"> <label for="delivery">Доставка</label>
      </div>

      <div id="address-fields" class="hidden mt-4 p-4 border rounded-md bg-gray-100">
        <h3 class="text-lg font-semibold mb-2">Адреса доставки:</h3>
        <div class="mb-3">
          <label for="city" class="block text-gray-700 text-sm font-bold mb-1">Місто:</label>
          <input type="text" id="city" name="city" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        <div class="mb-3">
          <label for="street" class="block text-gray-700 text-sm font-bold mb-1">Вулиця:</label>
          <input type="text" id="street" name="street" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        <div class="mb-3">
          <label for="house" class="block text-gray-700 text-sm font-bold mb-1">Будинок:</label>
          <input type="text" id="house" name="house" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
      </div>

      <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md mt-6 inline-block">Оформити замовлення</button>
    </form>
  </div>

  <div th:if="${cartItems != null and !cartItems.isEmpty() and #authentication?.authenticated == false}" class="text-center mt-6">
    <p class="text-xl text-gray-600">
      Для оформлення замовлення необхідно <a th:href="@{/login-form}">увійти</a> або <a th:href="@{/registration}">зареєструватися</a>.
    </p>
  </div>


</main>

<footer class="footer">
  <p>&copy; 2025 Cake House. Всі права захищені.</p>
  <div class="socials">
    <span>Instagram</span>
    <span>Facebook</span>
    <span>Telegram</span>
  </div>
</footer>

<script th:src="@{/js/cart.js}"></script>

</body>
</html>